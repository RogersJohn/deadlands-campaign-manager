# Wiki Visibility Fix - 2025-11-05

## Issue Reported

Player4 (now DaveOBrien) could only see:
- Their own public and private wiki entries (John Henry)
- Mexicali Bob's public entry

But NOT:
- All other PUBLIC entries (Civil War, Railroad Race, Global Affairs, etc.)

**Expected:** All players should see ALL public wiki entries, plus their own character-specific private entries.

---

## Root Cause

The `WikiEntryRepository` had **lazy loading issues** with the `relatedCharacter` relationship:

```java
@ManyToOne(fetch = FetchType.LAZY)
private Character relatedCharacter;
```

When the `WikiController.canUserAccess()` method tried to access:
- `entry.getRelatedCharacter()`
- `relatedChar.getPlayer()`

It could throw `LazyInitializationException` or return null unexpectedly, causing entries to be incorrectly filtered out.

---

## Solution Applied

### 1. Added JOIN FETCH to Repository Queries

Updated `WikiEntryRepository.java` to eagerly fetch related entities:

**Before:**
```java
@Query("SELECT w FROM WikiEntry w ORDER BY w.category, w.sortOrder, w.title")
List<WikiEntry> findAllOrdered();

Optional<WikiEntry> findBySlug(String slug);

List<WikiEntry> findByCategory(WikiEntry.Category category);
```

**After:**
```java
@Query("SELECT DISTINCT w FROM WikiEntry w " +
       "LEFT JOIN FETCH w.relatedCharacter c " +
       "LEFT JOIN FETCH c.player " +
       "ORDER BY w.category, w.sortOrder, w.title")
List<WikiEntry> findAllOrdered();

@Query("SELECT w FROM WikiEntry w " +
       "LEFT JOIN FETCH w.relatedCharacter c " +
       "LEFT JOIN FETCH c.player " +
       "WHERE w.slug = :slug")
Optional<WikiEntry> findBySlug(@Param("slug") String slug);

@Query("SELECT DISTINCT w FROM WikiEntry w " +
       "LEFT JOIN FETCH w.relatedCharacter c " +
       "LEFT JOIN FETCH c.player " +
       "WHERE w.category = :category " +
       "ORDER BY w.sortOrder, w.title")
List<WikiEntry> findByCategory(@Param("category") WikiEntry.Category category);
```

**Why this fixes it:**
- `LEFT JOIN FETCH` eagerly loads the `relatedCharacter` and `player` relationships
- This prevents lazy loading exceptions when checking access permissions
- `DISTINCT` prevents duplicate entries from the JOIN

---

### 2. Changed player4 Username

Updated database:
```sql
UPDATE users
SET username = 'DaveOBrien', email = 'daveobrien@deadlands.com'
WHERE username = 'player4'
```

---

## Expected Behavior After Fix

### All Players Should Now See:

**PUBLIC Entries (visible to everyone):**
1. The Great Civil War (campaign lore)
2. The Great Railroad Race (campaign lore)
3. Global Affairs & The Weird West (campaign lore)
4. Mexicali Bob - Public Profile (character bio)
5. John Henry Farraday - Public Profile (character bio)

**Plus Their Own CHARACTER_SPECIFIC Entries:**
- DaveOBrien (John Henry's player): John Henry Farraday - Secret Past
- player2 (Mexicali Bob's player): Mexicali Bob - Private Background
- player3 (Cornelius's player): Cornelius Wilberforce III - Biography
- player6 (Jack Horner's player): Jack Horner - The Old Prospector

**Game Master Sees:**
- ALL entries (public + all private)

---

## Testing Steps

After Railway deployment completes:

1. **Log in as DaveOBrien (formerly player4)**
   - Username: `DaveOBrien`
   - Password: `password` (default)

2. **Navigate to Wiki page**

3. **Verify you see 6 total entries:**
   - ✅ The Great Civil War (public)
   - ✅ The Great Railroad Race (public)
   - ✅ Global Affairs & The Weird West (public)
   - ✅ Mexicali Bob - Public Profile (public)
   - ✅ John Henry Farraday - Public Profile (public)
   - ✅ John Henry Farraday - Secret Past (private, yours)

4. **Test other players** - Each should see all 5 public + their own private

5. **Test GM** - Should see all 9 entries

---

## Files Changed

- `backend/src/main/java/com/deadlands/campaign/repository/WikiEntryRepository.java`
  - Added JOIN FETCH to all query methods

- Database:
  - Updated `users.username` for user_id=5 from 'player4' to 'DaveOBrien'
  - Updated `users.email` to 'daveobrien@deadlands.com'

---

## Deployment

✅ **Committed:** `git commit -m "Fix wiki visibility and update player4 username"`
✅ **Pushed:** `git push origin main`
⏳ **Railway:** Auto-deploying now (check Railway dashboard)

---

## If Issue Persists

If players still can't see all public entries after deployment:

1. **Check Railway Logs:** Look for any errors during startup
2. **Clear Browser Cache:** Sometimes JWT tokens cache old user info
3. **Log out and back in:** Refresh authentication token
4. **Check Database:** Verify visibility settings:
   ```sql
   SELECT id, title, visibility, is_public
   FROM wiki_entries
   WHERE visibility = 'PUBLIC'
   ORDER BY id;
   ```

---

**Fix Applied:** 2025-11-05
**Deployed to Railway:** Pending (auto-deploy from git push)
**New Username:** DaveOBrien (formerly player4)
